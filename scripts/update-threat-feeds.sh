#!/bin/bash

# ========================================================================
# Script de atualiza√ß√£o de Threat Intelligence Feeds para o SIMIR + Zeek
# ========================================================================

INTEL_DIR="/home/rafael/SIMIR/site/intel"
TEMP_DIR="/tmp/simir_threat_feeds"
BACKUP_DIR="/home/rafael/SIMIR/site/intel/backup"

# Contadores
total_ips=0
total_domains=0
feeds_success=0
feeds_failed=0

echo "üîÑ Atualizando feeds de threat intelligence..."
echo "üìÖ $(date)"

# Criar diret√≥rios
mkdir -p "$TEMP_DIR" "$BACKUP_DIR"

# ========================================================================
# Fun√ß√µes
# ========================================================================

backup_existing_feeds() {
    echo "üì¶ Fazendo backup dos feeds existentes..."
    timestamp=$(date +"%Y%m%d_%H%M%S")
    for file in "$INTEL_DIR"/*.txt; do
        if [ -f "$file" ]; then
            cp "$file" "$BACKUP_DIR/$(basename "$file" .txt)_$timestamp.txt"
        fi
    done
}

convert_abusech_ips() {
    local input="$1"
    local output="$2"
    local source="$3"

    echo "#fields	indicator	indicator_type	meta.source	meta.desc" > "$output"
    grep -v "^#\|^$\|^DstIP" "$input" | while read -r ip; do
        ip=$(echo "$ip" | tr -d '[:space:]')
        if [[ "$ip" =~ ^[0-9]+\.[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
            echo -e "$ip\tIntel::ADDR\t$source\tIP malicioso" >> "$output"
        fi
    done
}

convert_urlhaus_domains() {
    local input="$1"
    local output="$2"

    echo "#fields	indicator	indicator_type	meta.source	meta.desc" > "$output"
    grep -E "^(0\.0\.0\.0|127\.0\.0\.1)" "$input" | awk '{print $2}' | grep -v "localhost" | while read -r domain; do
        domain=$(echo "$domain" | tr -d '[:space:]')
        if [ -n "$domain" ] && [[ "$domain" =~ ^[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}$ ]]; then
            echo -e "$domain\tIntel::DOMAIN\tURLhaus\tDom√≠nio malicioso" >> "$output"
        fi
    done
}

process_spamhaus_drop() {
    local input="$1"
    local output="$2"

    echo "#fields	indicator	indicator_type	meta.source	meta.desc" > "$output"
    grep -v "^;" "$input" | while read -r line; do
        ip=$(echo "$line" | cut -d';' -f1 | cut -d'/' -f1)
        if [[ "$ip" =~ ^[0-9]+\.[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
            echo -e "$ip\tIntel::ADDR\tSpamhaus\tIP malicioso - Spamhaus DROP" >> "$output"
        fi
    done
}

check_docker_permissions() {
    if docker ps >/dev/null 2>&1; then
        return 0
    else
        return 1
    fi
}

# ========================================================================
# Execu√ß√£o
# ========================================================================

backup_existing_feeds
echo ""
echo "üåê Baixando feeds de fontes p√∫blicas..."

# 1. Abuse.ch Feodo Tracker
echo "  üì° Feodo Tracker (Botnet IPs)..."
if curl -s --connect-timeout 30 --max-time 60 \
    "https://feodotracker.abuse.ch/downloads/ipblocklist.txt" \
    -o "$TEMP_DIR/feodo_ips.txt"; then
    if [ -s "$TEMP_DIR/feodo_ips.txt" ]; then
        convert_abusech_ips "$TEMP_DIR/feodo_ips.txt" "$INTEL_DIR/feodo-ips.txt" "Feodo"
        count=$(grep -v "^#" "$INTEL_DIR/feodo-ips.txt" | wc -l)
        total_ips=$((total_ips + count))
        feeds_success=$((feeds_success + 1))
        echo "    ‚úÖ $count IPs de botnet baixados"
    else
        feeds_failed=$((feeds_failed + 1))
        echo "    ‚ùå Arquivo vazio recebido"
    fi
else
    feeds_failed=$((feeds_failed + 1))
    echo "    ‚ùå Falha no download"
fi

# 2. Abuse.ch URLhaus
echo "  üåê URLhaus (Dom√≠nios maliciosos)..."
if curl -s --connect-timeout 30 --max-time 60 \
    "https://urlhaus.abuse.ch/downloads/hostfile/" \
    -o "$TEMP_DIR/urlhaus_domains.txt"; then
    if [ -s "$TEMP_DIR/urlhaus_domains.txt" ]; then
        convert_urlhaus_domains "$TEMP_DIR/urlhaus_domains.txt" "$INTEL_DIR/urlhaus-domains.txt"
        count=$(grep -v "^#" "$INTEL_DIR/urlhaus-domains.txt" | wc -l)
        total_domains=$((total_domains + count))
        feeds_success=$((feeds_success + 1))
        echo "    ‚úÖ $count dom√≠nios maliciosos baixados"
    else
        feeds_failed=$((feeds_failed + 1))
        echo "    ‚ùå Arquivo vazio recebido"
    fi
else
    feeds_failed=$((feeds_failed + 1))
    echo "    ‚ùå Falha no download"
fi

# 3. Spamhaus DROP
echo "  üö´ Spamhaus DROP (IPs maliciosos)..."
if curl -s --connect-timeout 30 --max-time 60 \
    "https://www.spamhaus.org/drop/drop.txt" \
    -o "$TEMP_DIR/spamhaus_drop.txt"; then
    if [ -s "$TEMP_DIR/spamhaus_drop.txt" ]; then
        process_spamhaus_drop "$TEMP_DIR/spamhaus_drop.txt" "$INTEL_DIR/spamhaus-drop.txt"
        count=$(grep -v "^#" "$INTEL_DIR/spamhaus-drop.txt" | wc -l)
        total_ips=$((total_ips + count))
        feeds_success=$((feeds_success + 1))
        echo "    ‚úÖ $count IPs Spamhaus baixados"
    else
        feeds_failed=$((feeds_failed + 1))
        echo "    ‚ùå Arquivo vazio recebido"
    fi
else
    feeds_failed=$((feeds_failed + 1))
    echo "    ‚ùå Falha no download"
fi

# 4. Tor Exit Nodes
echo "  üîí Tor Exit Nodes..."
if curl -s --connect-timeout 30 --max-time 60 \
    "https://check.torproject.org/torbulkexitlist" \
    -o "$TEMP_DIR/tor_exits.txt"; then
    if [ -s "$TEMP_DIR/tor_exits.txt" ]; then
        echo "#fields	indicator	indicator_type	meta.source	meta.desc" > "$INTEL_DIR/tor-exits.txt"
        grep -E "^[0-9]+\.[0-9]+\.[0-9]+\.[0-9]+$" "$TEMP_DIR/tor_exits.txt" | while read -r ip; do
            echo -e "$ip\tIntel::ADDR\tTorProject\tTor exit node" >> "$INTEL_DIR/tor-exits.txt"
        done
        count=$(grep -v "^#" "$INTEL_DIR/tor-exits.txt" | wc -l)
        total_ips=$((total_ips + count))
        feeds_success=$((feeds_success + 1))
        echo "    ‚úÖ $count Tor exits baixados"
    else
        feeds_failed=$((feeds_failed + 1))
        echo "    ‚ùå Arquivo vazio recebido"
    fi
else
    feeds_failed=$((feeds_failed + 1))
    echo "    ‚ùå Falha no download"
fi

# 5. Hostfile.org
echo "  ü¶† Hostfile.org (Dom√≠nios maliciosos)..."
if curl -L -s --connect-timeout 30 --max-time 60 \
    "https://someonewhocares.org/hosts/zero/hosts" \
    -o "$TEMP_DIR/hostfile_domains.txt"; then
    if [ -s "$TEMP_DIR/hostfile_domains.txt" ]; then
        echo "#fields	indicator	indicator_type	meta.source	meta.desc" > "$INTEL_DIR/hostfile-domains.txt"
        grep "^0\.0\.0\.0" "$TEMP_DIR/hostfile_domains.txt" | awk '{print $2}' | grep -v "localhost\|0.0.0.0" | while read -r domain; do
            domain=$(echo "$domain" | tr -d '[:space:]')
            if [ -n "$domain" ] && [[ "$domain" =~ ^[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}$ ]]; then
                echo -e "$domain\tIntel::DOMAIN\tHostfile\tDom√≠nio malicioso" >> "$INTEL_DIR/hostfile-domains.txt"
            fi
        done
        count=$(grep -v "^#" "$INTEL_DIR/hostfile-domains.txt" | wc -l)
        total_domains=$((total_domains + count))
        feeds_success=$((feeds_success + 1))
        echo "    ‚úÖ $count dom√≠nios Hostfile baixados"
    else
        feeds_failed=$((feeds_failed + 1))
        echo "    ‚ùå Arquivo vazio recebido"
    fi
else
    feeds_failed=$((feeds_failed + 1))
    echo "    ‚ùå Falha no download do Hostfile.org"
fi

# ========================================================================
# Atualizar configura√ß√£o do Zeek
# ========================================================================
echo ""
echo "üîß Atualizando configura√ß√£o do Zeek..."
feeds=(
    "feodo-ips.txt"
    "urlhaus-domains.txt" 
    "spamhaus-drop.txt"
    "tor-exits.txt"
    "hostfile-domains.txt"
)

config_file="/home/rafael/SIMIR/site/intelligence-framework.zeek"
for feed in "${feeds[@]}"; do
    if [ -f "$INTEL_DIR/$feed" ] && ! grep -q "$feed" "$config_file"; then
        if grep -q "Intel::read_files" "$config_file"; then
            sed -i "/malicious-.*\.txt\"/a\\    \"/usr/local/zeek/share/zeek/site/intel/$feed\"," "$config_file"
            echo "    ‚ûï Adicionado $feed √† configura√ß√£o"
        fi
    fi
done

# Limpeza
rm -rf "$TEMP_DIR"

# ========================================================================
# Resumo
# ========================================================================
echo ""
echo "üìä Resumo dos feeds atualizados:"
for file in "$INTEL_DIR"/*.txt; do
    if [ -f "$file" ]; then
        name=$(basename "$file")
        count=$(grep -v "^#" "$file" | wc -l 2>/dev/null || echo "0")
        echo "  üìÑ $name: $count entradas"
    fi
done

echo ""
echo "üìà Total de indicadores de amea√ßas baixados: $((total_ips + total_domains))"
echo "   ‚îú‚îÄ IPs maliciosos: $total_ips"
echo "   ‚îî‚îÄ Dom√≠nios maliciosos: $total_domains"

# ========================================================================
# Reiniciar Zeek
# ========================================================================
echo ""
echo "üîÑ Reiniciando Zeek para carregar novos feeds..."
if command -v docker-compose &> /dev/null; then
    if check_docker_permissions; then
        if docker-compose ps | grep -q "SIMIR_Z"; then
            docker-compose restart SIMIR_Z
            echo "    ‚úÖ Container Zeek reiniciado"
        else
            echo "    ‚ö†Ô∏è  Container n√£o est√° rodando. Inicie com: docker-compose up -d"
        fi
    else
        echo "    ‚ÑπÔ∏è  Usando sudo para acessar Docker"
        if sudo docker-compose ps | grep -q "SIMIR_Z"; then
            sudo docker-compose restart SIMIR_Z
            echo "    ‚úÖ Container Zeek reiniciado com sudo"
        else
            echo "    ‚ö†Ô∏è  Container n√£o est√° rodando. Inicie com: sudo docker-compose up -d"
        fi
    fi
else
    echo "    ‚ö†Ô∏è  docker-compose n√£o encontrado"
fi

# ========================================================================
# Finaliza√ß√£o
# ========================================================================
echo ""
echo "‚úÖ Atualiza√ß√£o de feeds conclu√≠da!"
echo "üìÖ $(date)"
echo ""
echo "üìä Estat√≠sticas da execu√ß√£o:"
echo "   üéØ Total de indicadores baixados: $((total_ips + total_domains))"
echo "   ‚îú‚îÄ üî¥ IPs maliciosos: $total_ips"
echo "   ‚îî‚îÄ üåê Dom√≠nios maliciosos: $total_domains"
echo ""
echo "   üìà Status dos feeds:"
echo "   ‚îú‚îÄ ‚úÖ Feeds com sucesso: $feeds_success"
echo "   ‚îî‚îÄ ‚ùå Feeds com falha: $feeds_failed"
echo ""
if [ $feeds_success -gt 0 ]; then
    echo "üõ°Ô∏è  O SIMIR agora monitora automaticamente todos estes indicadores!"
else
    echo "‚ö†Ô∏è  Nenhum feed foi baixado com sucesso. Verifique conectividade de rede."
fi