#!/bin/bash

# Script completo para baixar feeds de threat intelligence atualizados
## 1. Abuse.ch Feodo Tracker (Botnet IPs)
echo "  üì° Feodo Tracker (Botnet IPs)..."
if curl -s --connect-timeout 30 --max-time 60 \
    "https://feodotracker.abuse.ch/downloads/ipblocklist.txt" \
    -o "$TEMP_DIR/feodo_ips.txt"; then
    if [ -s "$TEMP_DIR/feodo_ips.txt" ]; then
        convert_abusech_ips "$TEMP_DIR/feodo_ips.txt" "$INTEL_DIR/feodo-ips.txt" "Feodo"
        count=$(grep -v "^#" "$INTEL_DIR/feodo-ips.txt" | wc -l)
        total_ips=$((total_ips + count))
        feeds_success=$((feeds_success + 1))
        echo "    ‚úÖ $count IPs de botnet baixados"
    else
        feeds_failed=$((feeds_failed + 1))
        echo "    ‚ùå Arquivo vazio recebido"
    fi
else
    feeds_failed=$((feeds_failed + 1))
    echo "    ‚ùå Falha no download"
fie.ch, Spamhaus, Tor Project, e outras fontes p√∫blicas

INTEL_DIR="/home/rafael/SIMIR/site/intel"
TEMP_DIR="/tmp/simir_threat_feeds"
BACKUP_DIR="/home/rafael/SIMIR/site/intel/backup"

# Contadores para o resumo final
total_ips=0
total_domains=0
feeds_success=0
feeds_failed=0

echo "üîÑ Atualizando feeds de threat intelligence..."
echo "üìÖ $(date)"

# Criar diret√≥rios necess√°rios
mkdir -p "$TEMP_DIR" "$BACKUP_DIR"

# Fun√ß√£o para fazer backup
backup_existing_feeds() {
    echo "üì¶ Fazendo backup dos feeds existentes..."
    timestamp=$(date +"%Y%m%d_%H%M%S")
    for file in "$INTEL_DIR"/*.txt; do
        if [ -f "$file" ]; then
            cp "$file" "$BACKUP_DIR/$(basename "$file" .txt)_$timestamp.txt"
        fi
    done
}

# Fun√ß√£o para converter IPs do Abuse.ch
convert_abusech_ips() {
    local input="$1"
    local output="$2"
    local source="$3"
    
    echo "#fields	indicator	indicator_type	meta.source	meta.desc" > "$output"
    # Remove coment√°rios, linha DstIP e linhas vazias
    grep -v "^#\|^$\|^DstIP" "$input" | while read -r ip; do
        # Remove espa√ßos em branco e verifica se √© IP v√°lido
        ip=$(echo "$ip" | tr -d '[:space:]')
        if [[ "$ip" =~ ^[0-9]+\.[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
            echo -e "$ip\tIntel::ADDR\t$source\tIP malicioso" >> "$output"
        fi
    done
}

# Fun√ß√£o para converter dom√≠nios do URLhaus
convert_urlhaus_domains() {
    local input="$1"
    local output="$2"
    
    echo "#fields	indicator	indicator_type	meta.source	meta.desc" > "$output"
    # URLhaus usa 127.0.0.1 em vez de 0.0.0.0
    grep -E "^(0\.0\.0\.0|127\.0\.0\.1)" "$input" | awk '{print $2}' | grep -v "localhost" | while read -r domain; do
        # Remove espa√ßos e verifica se √© dom√≠nio v√°lido
        domain=$(echo "$domain" | tr -d '[:space:]')
        if [ -n "$domain" ] && [[ "$domain" =~ ^[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}$ ]]; then
            echo -e "$domain\tIntel::DOMAIN\tURLhaus\tDom√≠nio malicioso" >> "$output"
        fi
    done
}

# Fun√ß√£o para processar Spamhaus DROP
process_spamhaus_drop() {
    local input="$1"
    local output="$2"
    
    echo "#fields	indicator	indicator_type	meta.source	meta.desc" > "$output"
    grep -v "^;" "$input" | while read -r line; do
        ip=$(echo "$line" | cut -d';' -f1 | cut -d'/' -f1)
        if [[ "$ip" =~ ^[0-9]+\.[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
            echo -e "$ip\tIntel::ADDR\tSpamhaus\tIP malicioso - Spamhaus DROP" >> "$output"
        fi
    done
}

# Fazer backup
backup_existing_feeds

echo ""
echo "üåê Baixando feeds de fontes p√∫blicas..."

# 1. Abuse.ch Feodo Tracker (Botnet IPs)
echo "  üì° Feodo Tracker (Botnet IPs)..."
if curl -s --connect-timeout 30 --max-time 60 \
    "https://feodotracker.abuse.ch/downloads/ipblocklist.txt" \
    -o "$TEMP_DIR/feodo_ips.txt"; then
    if [ -s "$TEMP_DIR/feodo_ips.txt" ]; then
        convert_abusech_ips "$TEMP_DIR/feodo_ips.txt" "$INTEL_DIR/feodo-ips.txt" "Feodo"
        count=$(grep -v "^#" "$INTEL_DIR/feodo-ips.txt" | wc -l)
        echo "    ‚úÖ $count IPs de botnet baixados"
    fi
else
    echo "    ‚ùå Falha no download"
fi

# 2. Abuse.ch URLhaus (Malware domains)
echo "  üåê URLhaus (Dom√≠nios maliciosos)..."
if curl -s --connect-timeout 30 --max-time 60 \
    "https://urlhaus.abuse.ch/downloads/hostfile/" \
    -o "$TEMP_DIR/urlhaus_domains.txt"; then
    if [ -s "$TEMP_DIR/urlhaus_domains.txt" ]; then
        convert_urlhaus_domains "$TEMP_DIR/urlhaus_domains.txt" "$INTEL_DIR/urlhaus-domains.txt"
        count=$(grep -v "^#" "$INTEL_DIR/urlhaus-domains.txt" | wc -l)
        total_domains=$((total_domains + count))
        feeds_success=$((feeds_success + 1))
        echo "    ‚úÖ $count dom√≠nios maliciosos baixados"
    else
        feeds_failed=$((feeds_failed + 1))
        echo "    ‚ùå Arquivo vazio recebido"
    fi
else
    feeds_failed=$((feeds_failed + 1))
    echo "    ‚ùå Falha no download"
fi

# 3. Spamhaus DROP (IPs para bloquear)
echo "  üö´ Spamhaus DROP (IPs maliciosos)..."
if curl -s --connect-timeout 30 --max-time 60 \
    "https://www.spamhaus.org/drop/drop.txt" \
    -o "$TEMP_DIR/spamhaus_drop.txt"; then
    if [ -s "$TEMP_DIR/spamhaus_drop.txt" ]; then
        process_spamhaus_drop "$TEMP_DIR/spamhaus_drop.txt" "$INTEL_DIR/spamhaus-drop.txt"
        count=$(grep -v "^#" "$INTEL_DIR/spamhaus-drop.txt" | wc -l)
        total_ips=$((total_ips + count))
        feeds_success=$((feeds_success + 1))
        echo "    ‚úÖ $count IPs Spamhaus baixados"
    else
        feeds_failed=$((feeds_failed + 1))
        echo "    ‚ùå Arquivo vazio recebido"
    fi
else
    feeds_failed=$((feeds_failed + 1))
    echo "    ‚ùå Falha no download"
fi

# 4. Tor Project (Exit nodes)
echo "  üîí Tor Exit Nodes..."
if curl -s --connect-timeout 30 --max-time 60 \
    "https://check.torproject.org/torbulkexitlist" \
    -o "$TEMP_DIR/tor_exits.txt"; then
    if [ -s "$TEMP_DIR/tor_exits.txt" ]; then
        echo "#fields	indicator	indicator_type	meta.source	meta.desc" > "$INTEL_DIR/tor-exits.txt"
        grep -E "^[0-9]+\.[0-9]+\.[0-9]+\.[0-9]+$" "$TEMP_DIR/tor_exits.txt" | while read -r ip; do
            echo -e "$ip\tIntel::ADDR\tTorProject\tTor exit node" >> "$INTEL_DIR/tor-exits.txt"
        done
        count=$(grep -v "^#" "$INTEL_DIR/tor-exits.txt" | wc -l)
        total_ips=$((total_ips + count))
        feeds_success=$((feeds_success + 1))
        echo "    ‚úÖ $count Tor exits baixados"
    else
        feeds_failed=$((feeds_failed + 1))
        echo "    ‚ùå Arquivo vazio recebido"
    fi
else
    feeds_failed=$((feeds_failed + 1))
    echo "    ‚ùå Falha no download"
fi

# 5. Alternativa ao MDL: Hostfile.org
echo "  ü¶† Hostfile.org (Dom√≠nios maliciosos)..."
if curl -L -s --connect-timeout 30 --max-time 60 \
    "https://someonewhocares.org/hosts/zero/hosts" \
    -o "$TEMP_DIR/hostfile_domains.txt"; then
    if [ -s "$TEMP_DIR/hostfile_domains.txt" ]; then
        echo "#fields	indicator	indicator_type	meta.source	meta.desc" > "$INTEL_DIR/hostfile-domains.txt"
        grep "^0\.0\.0\.0" "$TEMP_DIR/hostfile_domains.txt" | awk '{print $2}' | grep -v "localhost\|0.0.0.0" | while read -r domain; do
            domain=$(echo "$domain" | tr -d '[:space:]')
            if [ -n "$domain" ] && [[ "$domain" =~ ^[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}$ ]]; then
                echo -e "$domain\tIntel::DOMAIN\tHostfile\tDom√≠nio malicioso" >> "$INTEL_DIR/hostfile-domains.txt"
            fi
        done
        count=$(grep -v "^#" "$INTEL_DIR/hostfile-domains.txt" | wc -l)
        total_domains=$((total_domains + count))
        feeds_success=$((feeds_success + 1))
        echo "    ‚úÖ $count dom√≠nios Hostfile baixados"
    else
        feeds_failed=$((feeds_failed + 1))
        echo "    ‚ùå Arquivo vazio recebido"
    fi
else
    feeds_failed=$((feeds_failed + 1))
    echo "    ‚ùå Falha no download do Hostfile.org"
fi

# Atualizar configura√ß√£o do Zeek
echo ""
echo "üîß Atualizando configura√ß√£o do Zeek..."

# Lista de novos feeds para adicionar
feeds=(
    "feodo-ips.txt"
    "urlhaus-domains.txt" 
    "spamhaus-drop.txt"
    "tor-exits.txt"
    "hostfile-domains.txt"
)

# Adicionar feeds √† configura√ß√£o se n√£o existirem
config_file="/home/rafael/SIMIR/site/intelligence-framework.zeek"
for feed in "${feeds[@]}"; do
    if [ -f "$INTEL_DIR/$feed" ] && ! grep -q "$feed" "$config_file"; then
        # Encontrar a linha com Intel::read_files e adicionar o novo feed
        if grep -q "Intel::read_files" "$config_file"; then
            sed -i "/malicious-.*\.txt\"/a\\    \"/usr/local/zeek/share/zeek/site/intel/$feed\"," "$config_file"
            echo "    ‚ûï Adicionado $feed √† configura√ß√£o"
        fi
    fi
done

# Limpeza
rm -rf "$TEMP_DIR"

echo ""
echo "üìä Resumo dos feeds atualizados:"
total_indicators=0
for file in "$INTEL_DIR"/*.txt; do
    if [ -f "$file" ]; then
        name=$(basename "$file")
        count=$(grep -v "^#" "$file" | wc -l 2>/dev/null || echo "0")
        echo "  üìÑ $name: $count entradas"
        # Somar apenas os feeds baixados nesta execu√ß√£o (n√£o os de exemplo)
        if [[ "$name" =~ ^(feodo-ips|urlhaus-domains|spamhaus-drop|tor-exits|hostfile-domains)\.txt$ ]]; then
            total_indicators=$((total_indicators + count))
        fi
    fi
done

echo ""
echo "üìà Total de indicadores de amea√ßas baixados: $((total_ips + total_domains))"
echo "   ‚îú‚îÄ IPs maliciosos: $total_ips"
echo "   ‚îî‚îÄ Dom√≠nios maliciosos: $total_domains"

echo ""
echo "üîÑ Reiniciando Zeek para carregar novos feeds..."

# Fun√ß√£o para detectar se precisa de sudo
check_docker_permissions() {
    if docker ps >/dev/null 2>&1; then
        return 0  # N√£o precisa sudo
    else
        return 1  # Precisa sudo
    fi
}

if command -v docker-compose &> /dev/null; then
    if check_docker_permissions; then
        # Usu√°rio tem permiss√µes docker
        if docker-compose ps | grep -q "SIMIR_Z"; then
            docker-compose restart SIMIR_Z
            echo "    ‚úÖ Container Zeek reiniciado"
        else
            echo "    ‚ö†Ô∏è  Container n√£o est√° rodando. Inicie com: docker-compose up -d"
        fi
    else
        # Precisa usar sudo
        echo "    ‚ÑπÔ∏è  Usando sudo para acessar Docker (usu√°rio n√£o est√° no grupo docker)"
        if sudo docker-compose ps | grep -q "SIMIR_Z"; then
            sudo docker-compose restart SIMIR_Z
            echo "    ‚úÖ Container Zeek reiniciado com sudo"
        else
            echo "    ‚ö†Ô∏è  Container n√£o est√° rodando. Inicie com: sudo docker-compose up -d"
        fi
    fi
else
    echo "    ‚ö†Ô∏è  docker-compose n√£o encontrado"
    echo "    ‚ö†Ô∏è  Execute manualmente: [sudo] docker-compose restart SIMIR_Z"
fi

echo ""
echo "‚úÖ Atualiza√ß√£o de feeds conclu√≠da!"
echo "üìÖ $(date)"
echo ""
echo "üìä Estat√≠sticas da execu√ß√£o:"
echo "   üéØ Total de indicadores baixados: $((total_ips + total_domains))"
echo "   ‚îú‚îÄ üî¥ IPs maliciosos: $total_ips"
echo "   ‚îî‚îÄ üåê Dom√≠nios maliciosos: $total_domains"
echo ""
echo "   üìà Status dos feeds:"
echo "   ‚îú‚îÄ ‚úÖ Feeds com sucesso: $feeds_success"
echo "   ‚îî‚îÄ ‚ùå Feeds com falha: $feeds_failed"
echo ""
if [ $feeds_success -gt 0 ]; then
    echo "üõ°Ô∏è  O SIMIR agora monitora automaticamente todos estes indicadores!"
    echo "   Qualquer tr√°fego para IPs/dom√≠nios maliciosos ser√° detectado."
else
    echo "‚ö†Ô∏è  Nenhum feed foi baixado com sucesso. Verifique conectividade de rede."
fi
echo ""
echo "üß™ Para testar as detec√ß√µes:"
echo "   ./scripts/test-intelligence.sh"
echo ""
echo "üìä Para ver logs:"
echo "   tail -f logs/notice_PortScan_BruteForce.log | grep -i 'intelligence'"
